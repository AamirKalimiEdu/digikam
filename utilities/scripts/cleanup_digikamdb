#!/bin/sh

# Author: Andi Clemens, <andi dot clemens at gmx dot net>
#
# Description:
#
# This script will read in the digiKam configuration file to determine the
# database location. It will then make sure that digiKam is not running and
# call "sqlite3 DATABASE 'VACUUM;" on the database, to clean up and optimize
# the tables.
# This will often lead to great performance gain and a smaller database file
# size.

# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# VARIABLES
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------

script_name="Cleanup Databases"
script_version="1.0"

digikam_name="digiKam"
digikam_version=$(digikam -v | grep "$digikam_name" | cut -d: -f2 | sed 's/ //g')

config_group="Album Settings"
config_key="Database File Path"
config_file="digikamrc"

db_dir=$(kreadconfig --file "$config_file" --group "$config_group" --key "$config_key")
db_digikam="digikam[34].db"
db_thumbs="thumbnails-digikam.db"

header_offset=20

output_str_location="Location"
output_str_database="Database"

db_find_args="-type f"
db_find_cmd="$db_find_args -name '$db_digikam'"

# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# FUNCTIONS
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------

_log()
{
    if [ "$_DEBUG" = "true" ]; then
        echo 1>&2 "  => LOG: $@"
    fi
}

# -----------------------------------------------------------------------------

# $1: char
# $2: count (optional)
repeat_char()
{
    for i in $(seq ${2:-$header_offset}); do
        echo -n "$1"
    done
}

# -----------------------------------------------------------------------------

# $*: string
pretty_header()
{
    # use an offset to center text (default = $header_offset)
    offset=$(repeat_char " ")
    offset_length=$(expr $(expr length "$offset") \* 2)

    # calculate length
    str_length=$(expr length "$*")
    length=$(expr $str_length + $offset_length)

    # delimiter line
    delimiter=$(repeat_char "-" $length)

    # print header
    echo $delimiter
    echo "${offset}$*${offset}"
    echo $delimiter
}

# -----------------------------------------------------------------------------

checkForRunningProgram()
{
    _log "checkForRunningProgram: start"
    proc=$(pgrep -u $USER -x digikam)
    if [ "$proc" != "" ]
    then
        _log "$proc"
        echo "Please shutdown $digikam_name before running this script."
        _log "checkForRunningProgram: failed"
        return 1
    fi
    _log "checkForRunningProgram: finished"
    return 0
}

# -----------------------------------------------------------------------------

help()
{
    cat <<EOF
Usage: $(basename $0) <options>

options:
  -t            Include thumbnail databases
  -T            Only cleanup thumbnail databases
  -p <path>     Specify a different database path. The entry from the
                digiKam configuration file will be ignored. If the specified path is invalid,
                the entry from the configuration file will be used.
  -h            Show this help.
EOF
    exit 1
}

# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# MAIN
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------

_log "getopts: start"
_options=
while getopts "tTp:h" Option
do
    case $Option in
        t)  db_find_cmd="$db_find_cmd -or -name '$db_thumbs'";
                 _options="$_options -t";;
        T)  db_find_cmd="$db_find_args -name '$db_thumbs'";
                 _options="$_options -T";;
        p)  if [ -n $OPTARG ]; then 
                if [ -d $OPTARG ]; then
                    db_dir=$OPTARG
                        _options="$_options -p:$OPTARG"
                fi
            fi;;
        h)  help;
                _options="$_options -h";;
        *)  help;;
    esac
done
_log "getopts: options: $_options"
_log "getopts: finished"

# -----------------------------------------------------------------------------

checkForRunningProgram
if [ $? = 1 ]; then
    exit 1
fi

# -----------------------------------------------------------------------------

pretty_header "$script_name v$script_version ($digikam_name $digikam_version)"

# -----------------------------------------------------------------------------

# backup current working dir
curdir=$(pwd)
_log "current dir: $curdir"

# -----------------------------------------------------------------------------

# try to enter the database directory
_log "entering: $db_dir"
cd $db_dir 2&> /dev/null
if [ $? = 0 ]; then
    _log "current dir: $(pwd)"

    db_out="$output_str_database:"
    echo -e "$output_str_location:\t$(pwd)"

    for db in $(eval "find . $db_find_cmd 2> /dev/null")
    do
        echo -ne "${db_out:-"\\t"}\t$db ... "
        sqlite3 $db "VACUUM;"
        if [ $? = 0 ]
        then
            echo "done!"
        else
            echo "failed!"
        fi
        unset db_out
    done
    echo -e "\n=> Finished";
else
    echo -e "\nI was not able to enter the database folder.\n"
    echo "Make sure that the variable '$config_key' in your 'digikamrc' config file"
    echo "is set correctly and that you have permissions to access the database folder."
fi

# -----------------------------------------------------------------------------

# restore old working dir
_log "entering: $curdir"
cd $curdir
_log "current dir: $(pwd)"

